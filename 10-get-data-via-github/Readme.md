# Add a new data source

In this chapter we will add a new data source to our application. In this
tutorial we will provide access to some files of a private Github repo but
other data sources can be added in a similar fashion.

## Create a new middleware

The Middleware is in General a Proxy, that allows us to Request our own Server (NodeJS Application) which then sends a seperate Request to the defined location. This solves plenty Cross Domain Troubles and also allows us to add Header Information or manipulate the data that comes back on the server.

This is something, that only happens on the Server, therefor we will place it in the Server folder.

* **Create** a file named `src/server/middlewares/github-repo/index.js`


```js
import { GITHUB_BASIC_AUTH } from 'shared/config';

const cache = {};

const repoUrl = 'https://raw.githubusercontent.com/moonshiner-agency/LutzJsStackWalkthrough/master';
const route = '/repo';

function replaceUrls(text, serverUrl) {
  return text.replace(
    /https:\/\/github.com\/moonshiner-agency\/LutzJsStackWalkthrough\/blob\/master/g,
    serverUrl || 'http://localhost:8000/repo',
  );
}

const repoProxyMiddleware = (req, res, next) => {
  const url = `${repoUrl}${req.originalUrl.replace(route, '')}`;

  if (!url.toLowerCase().endsWith('md') &&
      !url.toLowerCase().endsWith('markdown')) {
    throw new Error('Filetype not allowed.');
  }

  const headers = {
    Authorization: GITHUB_BASIC_AUTH,
  };

  let dataSource;

  if (!Object.prototype.hasOwnProperty.call(cache, url)) {
    dataSource = fetch(url, { headers })
      .then(respone => respone.text())
      .then(text => replaceUrls(text, `http://${req.headers.host}/repo`))
      .then((text) => {
        cache[url] = text;
        return text;
      });
  } else {
    dataSource = new Promise(resolve => resolve(cache[url]));
  }

  res.header('Content-Type', 'text/plain');

  return dataSource
    .then(text => res.send(text))
    .catch(next);
};

export default repoProxyMiddleware;
```

* Add the middleware to routing by modifying `src/server/routing.js`:

```js
// [...]
import githubRepoProxy from './middlewares/github-repo';
// [...]
  app.use('/repo', githubRepoProxy);
// [...]
```

* Source [basic auth credential](https://en.wikipedia.org/wiki/Basic_access_authentication#Client_side) in `src/shared/config.js` from envinronment variable.

```js
export const GITHUB_BASIC_AUTH = `Basic ${process.env.GITHUB}`;
```

The reason the credential has to be sourced from env is that it should **NOT**
be added to the source code and commited to version control since it is private
information.

The credential can be generated by base64 enconding
`github-username:github-password`.

---

Back to the [previous section](09-managing-content/Readme.md) or the [table of contents](../Readme.md).
